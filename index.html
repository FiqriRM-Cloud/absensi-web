<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Hadir Siswa Interaktif</title>
    
    <!-- Favicon -->
    <link rel="icon" href="images/absen.ico" type="image/x-icon">
    
    <!-- DaisyUI & Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- External JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-base-200 min-h-screen">

    <!-- Modal Input Data Awal -->
    <div id="modal-overlay" class="modal modal-open cursor-pointer">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Selamat Datang!</h3>
            <p class="py-4">Silakan masukkan nama guru dan kelas untuk memulai sesi absensi.</p>
            <form id="initial-data-form">
                <div class="form-control w-full mb-4">
                    <label class="label"><span class="label-text">Nama Guru</span></label>
                    <input type="text" id="teacher-name-input" placeholder="Contoh: Rahmat Hidayat" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label"><span class="label-text">Nama Kelas</span></label>
                    <input type="text" id="class-name-input" placeholder="Contoh: XII IPA 1" class="input input-bordered w-full" required />
                </div>
                <div class="modal-action">
                    <button type="submit" class="btn btn-primary">Simpan & Mulai</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 hidden">
        <!-- Header -->
        <header class="card bg-base-100 shadow-md mb-6">
            <div class="card-body flex-row justify-between items-center">
                <div>
                    <h1 id="teacher-name-header" class="card-title text-2xl">Guru: Nama Guru</h1>
                    <p id="class-name-header">Kelas: Nama Kelas</p>
                </div>
                <button id="logout-button" class="btn btn-error">Keluar</button>
            </div>
        </header>

        <!-- View Toggler -->
        <div role="tablist" class="tabs tabs-boxed mb-6">
            <a role="tab" id="daily-view-btn" class="tab tab-active">Absensi Harian</a>
            <a role="tab" id="monthly-view-btn" class="tab">Rekap Bulanan</a>
        </div>

        <!-- Daily View -->
        <div id="daily-view" class="space-y-6">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <div class="flex justify-between items-center flex-wrap gap-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text">Pilih Tanggal</span></label>
                            <input type="date" id="attendance-date" class="input input-bordered">
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text">Tambah Siswa Baru</span></label>
                            <div class="join">
                                <input type="text" id="new-student-name" placeholder="Nama Siswa" class="input input-bordered join-item">
                                <button id="add-student-btn" class="btn btn-primary join-item">Tambah</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center flex-wrap gap-4">
                <button id="mark-all-present-btn" class="btn btn-success">Hadirkan Semua</button>
                <button id="export-daily-btn" class="btn btn-info">Export Harian (Excel)</button>
            </div>
            <div class="overflow-x-auto bg-base-100 rounded-lg shadow">
                <table class="table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Nama Siswa</th>
                            <th class="text-center">Status (Klik untuk Ganti)</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="student-list">
                        <!-- Student rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Monthly View -->
        <div id="monthly-view" class="hidden space-y-6">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <div class="flex justify-between items-center flex-wrap gap-4">
                        <div class="flex items-end gap-4 flex-wrap">
                            <div class="form-control">
                                <label class="label"><span class="label-text">Bulan</span></label>
                                <select id="month-select" class="select select-bordered"></select>
                            </div>
                            <div class="form-control">
                                <label class="label"><span class="label-text">Tahun</span></label>
                                <select id="year-select" class="select select-bordered"></select>
                            </div>
                            <button id="show-recap-btn" class="btn btn-primary">Tampilkan Rekap</button>
                        </div>
                        <div class="flex items-end gap-4 flex-wrap">
                            <button id="export-monthly-btn" class="btn btn-info">Export Rekap (Excel)</button>
                            <button id="generate-summary-btn" class="btn btn-accent">Buat Ringkasan AI</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="summary-container" class="card bg-base-100 shadow hidden">
                <div class="card-body">
                    <h2 class="card-title">Ringkasan AI</h2>
                    <p id="summary-text" class="text-base-content text-sm whitespace-pre-wrap">Klik tombol "Buat Ringkasan AI" untuk melihat analisis.</p>
                </div>
            </div>
            <div class="overflow-x-auto bg-base-100 rounded-lg shadow">
                <table id="monthly-recap-table" class="table table-zebra table-pin-rows">
                    <thead id="monthly-recap-header">
                        <!-- Recap header will be injected here -->
                    </thead>
                    <tbody id="monthly-recap-body">
                        <!-- Recap body will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer footer-center p-4 mt-6 text-base-content">
            <div>
                <p>&copy; 2024 Aplikasi Absensi Siswa - Didesain ulang dengan DaisyUI</p>
            </div>
        </footer>
    </div>

    <!-- Generic Modal -->
    <dialog id="generic-modal" class="modal">
        <div class="modal-box">
            <h3 id="modal-title" class="font-bold text-lg"></h3>
            <p id="modal-text" class="py-4"></p>
            <div id="modal-prompt-container" class="form-control w-full hidden">
                <label class="label">
                    <span id="modal-prompt-label" class="label-text"></span>
                </label>
                <input type="text" id="modal-prompt-input" class="input input-bordered w-full" />
            </div>
            <div class="modal-action">
                <button id="modal-confirm-btn" class="btn btn-primary">Ya</button>
                <button id="modal-cancel-btn" class="btn btn-ghost">Batal</button>
            </div>
        </div>
    </dialog>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const modalOverlay = document.getElementById('modal-overlay');
        const initialDataForm = document.getElementById('initial-data-form');
        const teacherNameInput = document.getElementById('teacher-name-input');
        const classNameInput = document.getElementById('class-name-input');
        const appContainer = document.getElementById('app-container');
        const classNameHeader = document.getElementById('class-name-header');
        const teacherNameHeader = document.getElementById('teacher-name-header');
        const logoutButton = document.getElementById('logout-button');
        const dailyView = document.getElementById('daily-view');
        const monthlyView = document.getElementById('monthly-view');
        const dailyViewBtn = document.getElementById('daily-view-btn');
        const monthlyViewBtn = document.getElementById('monthly-view-btn');
        const attendanceDate = document.getElementById('attendance-date');
        const studentList = document.getElementById('student-list');
        const newStudentName = document.getElementById('new-student-name');
        const addStudentBtn = document.getElementById('add-student-btn');
        const markAllPresentBtn = document.getElementById('mark-all-present-btn');
        const exportDailyBtn = document.getElementById('export-daily-btn');
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const showRecapBtn = document.getElementById('show-recap-btn');
        const monthlyRecapTable = document.getElementById('monthly-recap-table');
        const monthlyRecapHeader = document.getElementById('monthly-recap-header');
        const monthlyRecapBody = document.getElementById('monthly-recap-body');
        const exportMonthlyBtn = document.getElementById('export-monthly-btn');
        const generateSummaryBtn = document.getElementById('generate-summary-btn');
        const summaryContainer = document.getElementById('summary-container');
        const summaryText = document.getElementById('summary-text');

        // --- Modal Elements ---
        const genericModal = document.getElementById('generic-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalPromptContainer = document.getElementById('modal-prompt-container');
        const modalPromptLabel = document.getElementById('modal-prompt-label');
        const modalPromptInput = document.getElementById('modal-prompt-input');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // --- App State ---
        let students = [];
        let attendanceData = {};
        const STATUSES = {
            'TK': { name: 'Tanpa Keterangan', color: 'btn-ghost' },
            'H': { name: 'Hadir', color: 'btn-success' },
            'S': { name: 'Sakit', color: 'btn-warning' },
            'I': { name: 'Izin', color: 'btn-info' },
            'A': { name: 'Alfa', color: 'btn-error' }
        };
        const ORDERED_STATUS_KEYS = ['TK', 'H', 'S', 'I', 'A'];

        // --- Modal Logic ---
        const showModal = (title, text, type = 'alert', onConfirm = () => {}, promptLabel = '') => {
            modalTitle.textContent = title;
            modalText.textContent = text;
            
            modalPromptContainer.classList.add('hidden');
            modalPromptInput.value = '';

            if (type === 'alert') {
                modalCancelBtn.classList.add('hidden');
                modalConfirmBtn.textContent = 'OK';
            } else if (type === 'confirm') {
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.textContent = 'Ya';
                modalCancelBtn.textContent = 'Batal';
            } else if (type === 'prompt') {
                modalPromptContainer.classList.remove('hidden');
                modalPromptLabel.textContent = promptLabel;
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.textContent = 'Kirim';
                modalCancelBtn.textContent = 'Batal';
            }

            genericModal.showModal();

            // Clone and replace the button to remove old event listeners
            const newConfirmBtn = modalConfirmBtn.cloneNode(true);
            modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, modalConfirmBtn);
            
            const newCancelBtn = modalCancelBtn.cloneNode(true);
            modalCancelBtn.parentNode.replaceChild(newCancelBtn, modalCancelBtn);
            
            // Assign new references
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const closeHandler = () => {
                genericModal.close();
            };

            const confirmHandler = () => {
                if (type === 'prompt') {
                    onConfirm(modalPromptInput.value);
                } else {
                    onConfirm();
                }
                closeHandler();
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', closeHandler);
        };


        // --- Data Persistence ---
        const loadDataFromStorage = () => {
            students = JSON.parse(localStorage.getItem('students') || '[]');
            attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '{}');
        };
        const saveDataToStorage = () => {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
        };

        // --- Rendering ---
        const renderStudents = () => {
            const date = attendanceDate.value;
            if (!attendanceData[date]) attendanceData[date] = {};

            studentList.innerHTML = '';
            if (students.length === 0) {
                studentList.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada siswa.</td></tr>';
                return;
            }

            students.forEach((student, index) => {
                const currentStatusKey = attendanceData[date][student] || 'TK';
                const statusInfo = STATUSES[currentStatusKey];
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <th>${index + 1}</th>
                    <td>${student}</td>
                    <td class="text-center">
                        <button class="btn btn-sm w-32 ${statusInfo.color}" data-toggle-status-for-student="${student}">
                            ${statusInfo.name}
                        </button>
                    </td>
                    <td><button class="btn btn-xs btn-ghost" data-delete-student="${student}">Hapus</button></td>
                `;
                studentList.appendChild(tr);
            });
        };

        const renderMonthlyRecap = () => {
            const month = monthSelect.value;
            const year = yearSelect.value;
            if (!month || !year) return;
            
            const daysInMonth = new Date(year, month, 0).getDate();
            monthlyRecapHeader.innerHTML = '<tr><th>Nama Siswa</th>' + Array.from({length: daysInMonth}, (_, i) => `<th>${i+1}</th>`).join('') + '</tr>';

            monthlyRecapBody.innerHTML = '';
            students.forEach(student => {
                let row = `<td>${student}</td>`;
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = `${year}-${String(month).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const status = (attendanceData[date] && attendanceData[date][student]) || '-';
                    row += `<td>${status}</td>`;
                }
                monthlyRecapBody.innerHTML += `<tr>${row}</tr>`;
            });
        };

        // --- UI Updates ---
        const updateHeader = () => {
            teacherNameHeader.textContent = `Guru: ${localStorage.getItem('teacherName') || 'Nama Guru'}`;
            classNameHeader.textContent = `Kelas: ${localStorage.getItem('className') || 'Nama Kelas'}`;
        };

        const populateDateSelects = () => {
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const currentMonth = new Date().getMonth();
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i + 1}" ${i === currentMonth ? 'selected' : ''}>${m}</option>`).join('');

            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = Array.from({length: 6}, (_, i) => `<option value="${currentYear - i}">${currentYear - i}</option>`).join('');
        };

        // --- Event Handlers ---
        const handleInitialFormSubmit = (e) => {
            e.preventDefault();
            localStorage.setItem('teacherName', teacherNameInput.value.trim());
            localStorage.setItem('className', classNameInput.value.trim());
            modalOverlay.classList.add("hidden");
            appContainer.classList.remove("hidden");
            initApp();
        };

        const handleStudentListInteraction = (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const studentToToggle = target.dataset.toggleStatusForStudent;
            const studentToDelete = target.dataset.deleteStudent;

            if (studentToToggle) {
                const date = attendanceDate.value;
                const currentStatus = attendanceData[date]?.[studentToToggle] || 'TK';
                const currentIndex = ORDERED_STATUS_KEYS.indexOf(currentStatus);
                const nextIndex = (currentIndex + 1) % ORDERED_STATUS_KEYS.length;
                const nextStatus = ORDERED_STATUS_KEYS[nextIndex];
                
                if (!attendanceData[date]) attendanceData[date] = {};
                attendanceData[date][studentToToggle] = nextStatus;
                
                saveDataToStorage();
                renderStudents();
            } else if (studentToDelete) {
                showModal('Konfirmasi Hapus', `Yakin ingin menghapus siswa "${studentToDelete}"?`, 'confirm', () => {
                    students = students.filter(s => s !== studentToDelete);
                    Object.keys(attendanceData).forEach(date => delete attendanceData[date][studentToDelete]);
                    saveDataToStorage();
                    renderStudents();
                });
            }
        };

        const handleAddStudent = () => {
            const name = newStudentName.value.trim();
            if (name && !students.includes(name)) {
                students.push(name);
                newStudentName.value = '';
                saveDataToStorage();
                renderStudents();
            } else if (students.includes(name)) {
                showModal('Peringatan', 'Siswa dengan nama tersebut sudah ada.', 'alert');
            }
        };
        
        const handleMarkAllPresent = () => {
            const date = attendanceDate.value;
            if (!attendanceData[date]) attendanceData[date] = {};
            students.forEach(student => { attendanceData[date][student] = 'H'; });
            saveDataToStorage();
            renderStudents();
        };

        const logout = () => {
            showModal('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar? Semua data absensi akan dihapus.', 'confirm', () => {
                localStorage.clear();
                location.reload();
            });
        };

        const toggleView = (viewToShow) => {
            if (viewToShow === 'daily') {
                dailyView.classList.remove('hidden');
                monthlyView.classList.add('hidden');
                dailyViewBtn.classList.add('tab-active');
                monthlyViewBtn.classList.remove('tab-active');
            } else {
                dailyView.classList.add('hidden');
                monthlyView.classList.remove('hidden');
                dailyViewBtn.classList.remove('tab-active');
                monthlyViewBtn.classList.add('tab-active');
                renderMonthlyRecap();
            }
        };

        // --- AI Summary ---
        const generateAttendanceSummary = async () => {
            showModal('Input API Key', 'Masukkan Google API Key Anda untuk membuat ringkasan.', 'prompt', async (apiKey) => {
                if (!apiKey) {
                    showModal('Informasi', 'Pembuatan ringkasan dibatalkan karena API Key tidak dimasukkan.', 'alert');
                    return;
                }

                summaryContainer.classList.remove('hidden');
                summaryText.textContent = 'Membuat ringkasan, mohon tunggu...';
                
                const month = monthSelect.options[monthSelect.selectedIndex].text;
                const year = yearSelect.value;
                const promptData = `Buat ringkasan dan analisis data absensi kelas "${localStorage.getItem('className')}" (${localStorage.getItem('teacherName')}) bulan ${month} ${year}. Data JSON: ${JSON.stringify(attendanceData)}. Fokus pada: tingkat kehadiran, siswa paling sering absen (S, I, A), dan tren absensi. Beri kesimpulan dan saran.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptData }] }] })
                    });
                    if (!response.ok) throw new Error((await response.json()).error.message);
                    const data = await response.json();
                    summaryText.textContent = data.candidates[0].content.parts[0].text;
                } catch (error) {
                    summaryText.textContent = `Gagal membuat ringkasan. Error: ${error.message}`;
                }
            }, 'Google API Key');
        };

        // --- Excel Export ---
        const exportDaily = () => {
            const date = attendanceDate.value;
            const data = [["No", "Nama Siswa", "Status"]].concat(
                students.map((student, index) => [
                    index + 1,
                    student,
                    STATUSES[(attendanceData[date] && attendanceData[date][student]) || 'TK'].name
                ])
            );
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Absensi Harian");
            XLSX.writeFile(wb, `absensi_harian_${date}.xlsx`);
        };

        const exportMonthly = () => {
            const table = document.getElementById('monthly-recap-table');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Rekap Bulanan"});
            XLSX.writeFile(wb, `rekap_absensi_${monthSelect.options[monthSelect.selectedIndex].text}_${yearSelect.value}.xlsx`);
        };

        // --- Initialization ---
        const initApp = () => {
            attendanceDate.valueAsDate = new Date();
            populateDateSelects();
            loadDataFromStorage();
            updateHeader();
            renderStudents();
        };

        const checkSession = () => {
            if (localStorage.getItem('teacherName') && localStorage.getItem('className')) {
                modalOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initApp();
            } else {
                modalOverlay.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        };

        // --- Event Listeners ---
        initialDataForm.addEventListener('submit', handleInitialFormSubmit);
        studentList.addEventListener('click', handleStudentListInteraction);
        addStudentBtn.addEventListener('click', handleAddStudent);
        newStudentName.addEventListener('keypress', (e) => e.key === 'Enter' && handleAddStudent());
        markAllPresentBtn.addEventListener('click', handleMarkAllPresent);
        attendanceDate.addEventListener('change', renderStudents);
        logoutButton.addEventListener('click', logout);
        dailyViewBtn.addEventListener('click', () => toggleView('daily'));
        monthlyViewBtn.addEventListener('click', () => toggleView('monthly'));
        showRecapBtn.addEventListener('click', renderMonthlyRecap);
        exportDailyBtn.addEventListener('click', exportDaily);
        exportMonthlyBtn.addEventListener('click', exportMonthly);
        generateSummaryBtn.addEventListener('click', generateAttendanceSummary);

        // Initial Load
        checkSession();
    });
    </script>
</body>
</html>